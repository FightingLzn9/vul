## SQL Injection Vulnerability in findDeptPage.do of Tipray Data Leakage Prevention System

### Introduction
Tipray Data Leakage Prevention System is an intelligent approval platform focusing on enterprise data security and compliance management. It deeply integrates document encryption, permission control, and process automation, providing enterprises with full-lifecycle security management and control for files from creation, circulation to archiving.

The official website of the company developing this system is https://www.tipray.com/index.php

### Authentication Analysis
Next, let's analyze the authentication mechanism. As before, we start with `web.xml`. As mentioned earlier, the routing format in the Controller is `*.do`.

<img width="1096" height="475" alt="image" src="https://github.com/user-attachments/assets/215c39c0-5012-4604-9e3d-c0423620b25f" />

All `*.do` routes are filtered by `springSecurityFilterChain`. Let's further explore its logic.

As shown in the figure below, URL parsing is performed in `SecurityFilter#doFilter`. As is well known, this part is insecure and has a parsing bypass vulnerability.

The parsed URL is sent to `SessionFilter.isNoNeedValidate` for verification. If the return value is `true`, authentication is passed via `chain.doFilter`; otherwise, authentication is performed through the Authorization method, which is actually JWT-based authentication.

<img width="2305" height="501" alt="image" src="https://github.com/user-attachments/assets/4d34ab20-5558-4e07-b72a-beea025187ab" />

Let's continue to dive into `SessionFilter.isNoNeedValidate`.

<img width="2305" height="501" alt="image" src="https://github.com/user-attachments/assets/ed340be7-8c23-4bd7-897a-97b5d06faf96" />

It is obvious that there is a parsing bypass vulnerability here. We can use the format `/login.jsp/..;/xxx` to achieve the bypass.

At this point, the authentication mechanism of this system is invalid, and all backend function points are exposed to the frontend (accessible without authentication).

### SQL Injection Vulnerability
Since MyBatis is used, we can perform a global search for `${` to find any oversights (unsecured parameters).

<img width="1520" height="189" alt="image" src="https://github.com/user-attachments/assets/7c914ed2-b806-481e-abb4-66b9cac404b3" />

Let's trace back to the source: `PageVo`.

<img width="1409" height="1244" alt="image" src="https://github.com/user-attachments/assets/0caafdc9-1f5f-420d-93ec-c0bb0b899b41" />

This is an entity class. Theoretically, this class is used for front-end and back-end interaction, and its parameters are controllable by users.

Moreover, the `sort` parameter in this class is concatenated into `pageSql`, which is ultimately added to the aforementioned mapper, leading to injection. Therefore, it is clear that we only need to find which Controllers use this class.

We directly perform a global search for `import com.xxxx.bean.p000vo.PageVo` to see where this `PageVo` is used.

<img width="1679" height="634" alt="image" src="https://github.com/user-attachments/assets/a7fe99da-47d8-4c2e-b451-bbc12dff3601" />

It interacts with the Mapper layer.

<img width="1854" height="330" alt="image" src="https://github.com/user-attachments/assets/272806e7-1a5b-4dba-bc2a-4ed88ca83df4" />

We attempt to construct a payload for injection testing.

<img width="1855" height="813" alt="image" src="https://github.com/user-attachments/assets/872781bf-2afd-4db2-8d16-a629215c7edc" />

A 4-second delay confirms the existence of the injection.

Thus, it is confirmed that `findDeptPage.do` has an SQL injection vulnerability.

Thank you for your review. Wish you a pleasant day!
